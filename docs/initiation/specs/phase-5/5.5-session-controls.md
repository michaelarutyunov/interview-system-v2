# Spec 5.5: Session Controls

## Objective
Create the session controls component for managing interview sessions.

## Context
- Reference: v1 `src/ui/components/session_manager.py`
- Sidebar controls for session management
- Create new session
- Select existing session
- View session list
- Delete/close session
- Export session data

## Input Files
- Phase 1: `src/api/routes/sessions.py` - Session API endpoints
- v1: `/home/mikhailarutyunov/projects/graph-enabled-ai-interviewer/src/ui/components/session_manager.py`

## Output Files

### ui/components/controls.py
```python
"""
Session controls component for Streamlit demo UI.

Provides sidebar controls for:
- Creating new sessions
- Selecting existing sessions
- Viewing session list
- Deleting sessions
- Exporting session data
"""

from typing import Optional, List, Dict, Any
import streamlit as st

from ui.api_client import APIClient, SessionInfo


class SessionControls:
    """
    Manages session-related UI controls in the sidebar.
    
    Provides:
    - New session creation
    - Session selection from list
    - Session details display
    - Export functionality
    """
    
    def __init__(self, api_client: APIClient):
        """
        Initialize session controls.
        
        Args:
            api_client: API client for backend communication
        """
        self.api_client = api_client
    
    def render(self) -> Optional[SessionInfo]:
        """
        Render session controls in sidebar.
        
        Returns:
            Currently selected SessionInfo, or None
        """
        st.sidebar.title("ðŸŽ™ï¸ Interview System")
        st.sidebar.divider()
        
        # Tab navigation for session controls
        tab1, tab2, tab3 = st.sidebar.tabs(["New", "Sessions", "Export"])
        
        with tab1:
            self._render_new_session()
        
        with tab2:
            return self._render_session_list()
        
        with tab3:
            self._render_export()
        
        # Return current session from state
        return st.session_state.get("current_session")
    
    def _render_new_session(self):
        """Render new session creation form."""
        st.subheader("Create New Session")
        
        # Concept selection
        concept_id = st.selectbox(
            "Concept",
            options=["oat_milk_v1"],  # Add more as available
            label_visibility="collapsed",
        )
        
        # Optional parameters
        with st.expander("Advanced Options"):
            max_turns = st.number_input(
                "Max Turns",
                min_value=5,
                max_value=50,
                value=20,
            )
            
            target_coverage = st.slider(
                "Target Coverage",
                min_value=0.1,
                max_value=1.0,
                value=0.8,
                step=0.1,
            )
        
        # Create button
        if st.button("ðŸš€ Start Interview", type="primary", use_container_width=True):
            self._create_session(concept_id, max_turns, target_coverage)
    
    def _create_session(self, concept_id: str, max_turns: int, target_coverage: float):
        """Create a new session."""
        with st.spinner("Creating session..."):
            try:
                session_info = st.session_state.api_client.create_session(
                    concept_id=concept_id,
                    max_turns=max_turns,
                    target_coverage=target_coverage,
                )
                
                # Store in session state
                st.session_state.current_session = session_info
                st.session_state.chat_history = []
                st.session_state.opening_displayed = False
                
                st.success(f"Session {session_info.id[:8]} created!")
                st.rerun()
            
            except Exception as e:
                st.error(f"Failed to create session: {str(e)}")
    
    def _render_session_list(self) -> Optional[SessionInfo]:
        """Render session list and selection."""
        st.subheader("Sessions")
        
        # Load sessions
        if st.session_state.get("sessions") is None:
            self._load_sessions()
        
        sessions = st.session_state.get("sessions", [])
        
        if not sessions:
            st.info("No sessions found.")
            return None
        
        # Session selection
        session_options = {
            f"{s['id'][:8]} ({s.get('status', 'unknown')})": s
            for s in sessions
        }
        
        selected = st.selectbox(
            "Select Session",
            options=list(session_options.keys()),
            label_visibility="collapsed",
        )
        
        if selected:
            session = session_options[selected]
            
            # Display session details
            self._display_session_details(session)
            
            # Action buttons
            col1, col2 = st.columns(2)
            
            with col1:
                if st.button("ðŸ“‚ Load", use_container_width=True):
                    self._load_session(session)
            
            with col2:
                if st.button("ðŸ—‘ï¸ Delete", use_container_width=True):
                    self._delete_session(session['id'])
            
            # Set as current if loaded
            current = st.session_state.get("current_session")
            if current and current.id == session['id']:
                return current
        
        return None
    
    def _display_session_details(self, session: Dict[str, Any]):
        """Display details for a session."""
        with st.expander("Session Details"):
            st.write(f"**ID:** {session['id']}")
            st.write(f"**Status:** {session.get('status', 'unknown')}")
            st.write(f"**Concept:** {session.get('concept_id', 'N/A')}")
            
            created = session.get("created_at", "N/A")
            if created != "N/A":
                st.write(f"**Created:** {created}")
            
            if session.get("completed_at"):
                st.write(f"**Completed:** {session['completed_at']}")
    
    def _load_session(self, session: Dict[str, Any]):
        """Load an existing session."""
        session_id = session['id']
        
        with st.spinner(f"Loading session {session_id[:8]}..."):
            try:
                # Get full session info
                status = st.session_state.api_client.get_session_status(session_id)
                
                # Create SessionInfo
                session_info = SessionInfo(
                    id=session_id,
                    concept_id=session.get("concept_id", ""),
                    status=status.get("status", "unknown"),
                    created_at=session.get("created_at"),
                )
                
                st.session_state.current_session = session_info
                st.session_state.chat_history = []
                st.session_state.opening_displayed = False
                
                st.success(f"Session {session_id[:8]} loaded!")
                st.rerun()
            
            except Exception as e:
                st.error(f"Failed to load session: {str(e)}")
    
    def _delete_session(self, session_id: str):
        """Delete a session."""
        if not st.session_state.get("confirm_delete", False):
            st.session_state.confirm_delete = True
            st.warning("Click again to confirm deletion")
            return
        
        st.session_state.confirm_delete = False
        
        with st.spinner("Deleting session..."):
            try:
                client = st.session_state.api_client._get_client()
                client.delete(f"{st.session_state.api_client.base_url}/sessions/{session_id}")
                
                # Clear from state if it was current
                current = st.session_state.get("current_session")
                if current and current.id == session_id:
                    st.session_state.current_session = None
                    st.session_state.chat_history = []
                
                # Reload session list
                self._load_sessions()
                
                st.success("Session deleted!")
                st.rerun()
            
            except Exception as e:
                st.error(f"Failed to delete session: {str(e)}")
    
    def _load_sessions(self):
        """Load sessions from API."""
        try:
            sessions = st.session_state.api_client.list_sessions()
            st.session_state.sessions = sessions
        except Exception as e:
            st.error(f"Failed to load sessions: {str(e)}")
            st.session_state.sessions = []
    
    def _render_export(self):
        """Render export options."""
        st.subheader("Export Session")
        
        current = st.session_state.get("current_session")
        
        if not current:
            st.info("No session selected.")
            return
        
        st.write(f"Session: {current.id[:8]}")
        
        # Export format
        export_format = st.selectbox(
            "Format",
            options=["JSON", "Markdown"],
        )
        
        # Export button
        if st.button("ðŸ“¥ Export", use_container_width=True):
            self._export_session(current.id, export_format)
    
    def _export_session(self, session_id: str, format: str):
        """Export session data."""
        with st.spinner("Exporting..."):
            try:
                client = st.session_state.api_client._get_client()
                
                # Call export endpoint
                params = {"format": format.lower()}
                response = client.get(
                    f"{st.session_state.api_client.base_url}/sessions/{session_id}/export",
                    params=params,
                )
                response.raise_for_status()
                
                data = response.text
                
                # Display download button
                st.download_button(
                    label=f"Download {format}",
                    data=data,
                    file_name=f"session_{session_id[:8]}.{format.lower()}",
                    mime=f"application/{format.lower()}",
                    type="primary",
                )
            
            except Exception as e:
                st.error(f"Export failed: {str(e)}")


def initialize_session_state():
    """Initialize session-related state variables."""
    if "current_session" not in st.session_state:
        st.session_state.current_session = None
    if "sessions" not in st.session_state:
        st.session_state.sessions = None
    if "confirm_delete" not in st.session_state:
        st.session_state.confirm_delete = False


def get_current_session() -> Optional[SessionInfo]:
    """Get the current active session."""
    return st.session_state.get("current_session")


def clear_current_session():
    """Clear the current session."""
    st.session_state.current_session = None
    st.session_state.chat_history = []
    if "opening_displayed" in st.session_state:
        del st.session_state.opening_displayed
```

## Requirements
1. Create new session with concept selection
2. List and select existing sessions
3. Display session details
4. Load existing session
5. Delete session with confirmation
6. Export session to JSON/Markdown
7. Session state management

## Verification
```bash
# Verify imports
python3 -c "
from ui.components.controls import SessionControls, initialize_session_state, get_current_session
print('Session controls imported')
"

# Verify API client methods exist
python3 -c "
from ui.api_client import APIClient
client = APIClient()
assert hasattr(client, 'create_session')
assert hasattr(client, 'list_sessions')
print('API client has required methods')
"
```

## Success Criteria
- [ ] `ui/components/controls.py` created with SessionControls class
- [ ] `render()` - main sidebar rendering
- [ ] `_render_new_session()` - session creation form
- [ ] `_render_session_list()` - session list and selection
- [ ] `_render_export()` - export options
- [ ] `initialize_session_state()` - state initialization
- [ ] `get_current_session()` - get active session
- [ ] `clear_current_session()` - clear active session
- [ ] All API calls properly handled with error messages
- [ ] Components import without errors
