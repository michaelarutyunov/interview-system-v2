# Spec 1.4: Settings and Logging

## Objective
Create the application settings (Pydantic) and structured logging (structlog) configuration.

## Context
- Reference: ENGINEERING_GUIDE.md Section 4 (Configuration System)
- Reference: ENGINEERING_GUIDE.md Section 5 (Logging with structlog)

## Input Files
- `ENGINEERING_GUIDE.md` - Sections 4 and 5

## Output Files

### src/core/__init__.py
```python
"""Core application components."""
# noqa
```

### src/core/config.py
```python
"""
Application settings management.

Settings are loaded from environment variables with .env file support.
All configuration is validated using Pydantic.
"""

from pathlib import Path
from typing import Optional

from pydantic import Field
from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    """
    Application settings loaded from environment.
    
    Environment variables take precedence over .env file values.
    """
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore"
    )
    
    # ==========================================================================
    # Paths
    # ==========================================================================
    
    config_dir: Path = Field(
        default=Path("config"),
        description="Directory containing YAML configuration files"
    )
    data_dir: Path = Field(
        default=Path("data"),
        description="Directory for database and other data files"
    )
    
    # ==========================================================================
    # Database
    # ==========================================================================
    
    database_path: Path = Field(
        default=Path("data/interview.db"),
        description="Path to SQLite database file"
    )
    
    # ==========================================================================
    # LLM Configuration
    # ==========================================================================
    
    llm_provider: str = Field(
        default="anthropic",
        description="LLM provider to use"
    )
    anthropic_api_key: Optional[str] = Field(
        default=None,
        description="Anthropic API key"
    )
    llm_model: str = Field(
        default="claude-sonnet-4-20250514",
        description="LLM model identifier"
    )
    llm_temperature: float = Field(
        default=0.7,
        ge=0.0,
        le=2.0,
        description="LLM sampling temperature"
    )
    llm_max_tokens: int = Field(
        default=1024,
        ge=1,
        le=4096,
        description="Maximum tokens in LLM response"
    )
    llm_timeout_seconds: float = Field(
        default=30.0,
        ge=1.0,
        description="Timeout for LLM API calls"
    )
    
    # ==========================================================================
    # Interview Defaults
    # ==========================================================================
    
    default_max_turns: int = Field(
        default=20,
        ge=1,
        le=50,
        description="Default maximum turns per interview"
    )
    default_target_coverage: float = Field(
        default=0.8,
        ge=0.0,
        le=1.0,
        description="Default target coverage ratio"
    )
    
    # ==========================================================================
    # Server Configuration
    # ==========================================================================
    
    host: str = Field(
        default="127.0.0.1",
        description="Server host address"
    )
    port: int = Field(
        default=8000,
        ge=1,
        le=65535,
        description="Server port"
    )
    debug: bool = Field(
        default=False,
        description="Enable debug mode"
    )


# Global settings instance
settings = Settings()
```

### src/core/logging.py
```python
"""
Structured logging configuration using structlog.

Provides consistent, structured logging across the application with:
- JSON output in production
- Pretty console output in development
- Context binding for request tracing
"""

import logging
import sys
from typing import List

import structlog
from structlog.typing import Processor

from src.core.config import settings


def configure_logging() -> None:
    """
    Configure structlog for the application.
    
    Call this once at application startup, before any logging.
    """
    
    # Shared processors for all outputs
    shared_processors: List[Processor] = [
        # Add context from contextvars (for request-scoped context)
        structlog.contextvars.merge_contextvars,
        # Add log level to event dict
        structlog.processors.add_log_level,
        # Add timestamp in ISO format
        structlog.processors.TimeStamper(fmt="iso"),
        # Add extra attributes from stdlib logger
        structlog.stdlib.ExtraAdder(),
    ]
    
    if settings.debug:
        # Development: pretty console output with colors
        processors = shared_processors + [
            structlog.dev.ConsoleRenderer(colors=True)
        ]
    else:
        # Production: JSON output for log aggregation
        processors = shared_processors + [
            # Format exceptions as dicts
            structlog.processors.dict_tracebacks,
            # Render as JSON
            structlog.processors.JSONRenderer()
        ]
    
    structlog.configure(
        processors=processors,
        wrapper_class=structlog.make_filtering_bound_logger(logging.INFO),
        context_class=dict,
        logger_factory=structlog.PrintLoggerFactory(),
        cache_logger_on_first_use=True,
    )


def get_logger(name: str) -> structlog.BoundLogger:
    """
    Get a logger instance with the given name.
    
    Args:
        name: Logger name (typically __name__ of the module)
    
    Returns:
        Bound structlog logger
    
    Usage:
        from src.core.logging import get_logger
        
        log = get_logger(__name__)
        log.info("something_happened", key="value")
    """
    return structlog.get_logger(name)


def bind_context(**kwargs) -> None:
    """
    Bind context variables that will be included in all subsequent logs.
    
    Useful for request-scoped context like session_id:
    
        bind_context(session_id=session.id, request_id=request_id)
    
    Context is cleared when the async task completes.
    """
    structlog.contextvars.bind_contextvars(**kwargs)


def clear_context() -> None:
    """Clear all bound context variables."""
    structlog.contextvars.clear_contextvars()
```

### src/core/exceptions.py
```python
"""
Custom exception hierarchy for the interview system.

All application exceptions inherit from InterviewSystemError.
"""


class InterviewSystemError(Exception):
    """Base exception for all application errors."""
    pass


# =============================================================================
# Configuration Errors
# =============================================================================

class ConfigurationError(InterviewSystemError):
    """Invalid or missing configuration."""
    pass


# =============================================================================
# LLM Errors
# =============================================================================

class LLMError(InterviewSystemError):
    """Base for LLM-related errors."""
    pass


class LLMTimeoutError(LLMError):
    """LLM call timed out."""
    pass


class LLMRateLimitError(LLMError):
    """LLM rate limit exceeded."""
    pass


class LLMContentFilterError(LLMError):
    """Content filtered by LLM provider."""
    pass


class LLMResponseParseError(LLMError):
    """Failed to parse LLM response."""
    pass


# =============================================================================
# Session Errors
# =============================================================================

class SessionError(InterviewSystemError):
    """Session-related error."""
    pass


class SessionNotFoundError(SessionError):
    """Session does not exist."""
    pass


class SessionCompletedError(SessionError):
    """Attempted operation on completed session."""
    pass


class SessionAbandonedError(SessionError):
    """Session was abandoned."""
    pass


# =============================================================================
# Extraction Errors
# =============================================================================

class ExtractionError(InterviewSystemError):
    """Failed to extract concepts from response."""
    pass


# =============================================================================
# Graph Errors
# =============================================================================

class GraphError(InterviewSystemError):
    """Knowledge graph operation error."""
    pass


class NodeNotFoundError(GraphError):
    """Node does not exist."""
    pass


class DuplicateNodeError(GraphError):
    """Attempted to create duplicate node."""
    pass
```

### tests/unit/test_config.py
```python
"""Tests for configuration module."""

import os
import pytest
from pathlib import Path


def test_settings_defaults():
    """Settings have sensible defaults."""
    from src.core.config import Settings
    
    # Create fresh settings (don't use global)
    s = Settings()
    
    assert s.llm_provider == "anthropic"
    assert s.llm_model == "claude-sonnet-4-20250514"
    assert s.default_max_turns == 20
    assert s.default_target_coverage == 0.8
    assert s.debug == False


def test_settings_from_env():
    """Settings can be overridden via environment variables."""
    os.environ["DEBUG"] = "true"
    os.environ["DEFAULT_MAX_TURNS"] = "30"
    
    try:
        from src.core.config import Settings
        s = Settings()
        
        assert s.debug == True
        assert s.default_max_turns == 30
    finally:
        del os.environ["DEBUG"]
        del os.environ["DEFAULT_MAX_TURNS"]


def test_settings_validation():
    """Settings validate constraints."""
    from src.core.config import Settings
    from pydantic import ValidationError
    
    # Temperature out of range
    with pytest.raises(ValidationError):
        Settings(llm_temperature=3.0)
    
    # Coverage out of range
    with pytest.raises(ValidationError):
        Settings(default_target_coverage=1.5)


def test_global_settings_available():
    """Global settings instance is importable."""
    from src.core.config import settings
    
    assert settings is not None
    assert hasattr(settings, "database_path")
```

### tests/unit/test_logging.py
```python
"""Tests for logging module."""

import pytest
import structlog


def test_configure_logging():
    """Logging configuration runs without error."""
    from src.core.logging import configure_logging
    
    # Should not raise
    configure_logging()


def test_get_logger():
    """get_logger returns a bound logger."""
    from src.core.logging import configure_logging, get_logger
    
    configure_logging()
    log = get_logger("test")
    
    assert log is not None
    # Should be callable for logging
    assert callable(log.info)
    assert callable(log.error)


def test_logger_bind():
    """Logger can bind context."""
    from src.core.logging import configure_logging, get_logger
    
    configure_logging()
    log = get_logger("test")
    
    # Bind should return a new logger
    bound = log.bind(session_id="test-123")
    assert bound is not None


def test_context_binding():
    """Context variables can be bound and cleared."""
    from src.core.logging import configure_logging, bind_context, clear_context
    
    configure_logging()
    
    # Should not raise
    bind_context(request_id="req-123")
    clear_context()
```

### tests/unit/test_exceptions.py
```python
"""Tests for exception hierarchy."""

import pytest


def test_exception_hierarchy():
    """All exceptions inherit from InterviewSystemError."""
    from src.core.exceptions import (
        InterviewSystemError,
        ConfigurationError,
        LLMError,
        LLMTimeoutError,
        SessionError,
        SessionNotFoundError,
        ExtractionError,
        GraphError,
    )
    
    assert issubclass(ConfigurationError, InterviewSystemError)
    assert issubclass(LLMError, InterviewSystemError)
    assert issubclass(LLMTimeoutError, LLMError)
    assert issubclass(SessionError, InterviewSystemError)
    assert issubclass(SessionNotFoundError, SessionError)
    assert issubclass(ExtractionError, InterviewSystemError)
    assert issubclass(GraphError, InterviewSystemError)


def test_exceptions_can_be_raised():
    """Exceptions can be raised and caught."""
    from src.core.exceptions import SessionNotFoundError
    
    with pytest.raises(SessionNotFoundError):
        raise SessionNotFoundError("Session test-123 not found")
```

## Requirements
1. Settings must load from both environment variables and .env file
2. Settings must validate all constraints (ranges, types)
3. Logging must output JSON in production, pretty-print in debug
4. Logging must support context binding for request tracing
5. Exception hierarchy must allow granular error handling
6. All tests must pass

## Verification
```bash
# Assumes running from project root - no cd needed

# Check prerequisites
command -v pytest >/dev/null 2>&1 || pip3 install pytest
python3 -c "import pydantic" 2>/dev/null || pip3 install pydantic pydantic-settings
python3 -c "import structlog" 2>/dev/null || pip3 install structlog

# Run the tests
pytest tests/unit/test_config.py tests/unit/test_logging.py tests/unit/test_exceptions.py -v

# Expected: All tests pass

# Manual verification
python3 -c "from src.core.config import settings; print(settings.model_dump())"
python3 -c "from src.core.logging import configure_logging, get_logger; configure_logging(); get_logger('test').info('test_message')"
```

## Success Criteria
- [ ] Settings load from environment and .env
- [ ] Settings validate constraints (try invalid values)
- [ ] Logging outputs structured format
- [ ] Logger context binding works
- [ ] Exception hierarchy is correct
- [ ] All tests pass
