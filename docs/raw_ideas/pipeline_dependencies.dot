digraph PipelineArchitecture {
    rankdir=TB;
    splines=ortho;
    fontname="Helvetica";
    fontsize=11;

    // Define clusters for layers
    subgraph cluster_api {
        label="API Layer (HTTP only)";
        style=filled;
        color=lightblue;
        API [label="API Routes\n(sessions.py)", shape=box, style="rounded,filled", fillcolor=white];
    }

    subgraph cluster_service {
        label="Service Layer";
        style=filled;
        color=lightgreen;
        SessionService [label="SessionService\n(process_turn: 21 lines)", shape=box, style="rounded,filled", fillcolor=white];
    }

    subgraph cluster_pipeline {
        label="Pipeline Layer (TurnPipeline)";
        style=filled;
        color=lightyellow;
        Pipeline [label="TurnPipeline\n.execute()", shape=diamond, style="filled", fillcolor=white];

        // Stages
        subgraph cluster_stages {
            label="10 Pipeline Stages (Independent)";
            style=dashed;

            Stage1 [label="1. ContextLoading\n(load session metadata)", shape=note, style="filled", fillcolor=lightcyan];
            Stage2 [label="2. UtteranceSaving\n(save user input)", shape=note, style="filled", fillcolor=lightcyan];
            Stage3 [label="3. Extraction\n(extract concepts)", shape=note, style="filled", fillcolor=lightcyan];
            Stage4 [label="4. GraphUpdate\n(add to graph)", shape=note, style="filled", fillcolor=lightcyan];
            Stage5 [label="5. StateComputation\n(refresh graph state)", shape=note, style="filled", fillcolor=lightcyan];
            Stage6 [label="6. StrategySelection\n(select strategy)", shape=note, style="filled", fillcolor=lightcyan];
            Stage7 [label="7. Continuation\n(decide to continue)", shape=note, style="filled", fillcolor=lightcyan];
            Stage8 [label="8. QuestionGeneration\n(generate question)", shape=note, style="filled", fillcolor=lightcyan];
            Stage9 [label="9. ResponseSaving\n(save system utterance)", shape=note, style="filled", fillcolor=lightcyan];
            Stage10 [label="10. ScoringPersistence\n(save scoring data)", shape=note, style="filled", fillcolor=lightcyan];
        }
    }

    subgraph cluster_repositories {
        label="Repository Layer (Database Access)";
        style=filled;
        color=lightcoral;
        SessionRepo [label="SessionRepository", shape=cylinder, style="filled", fillcolor=white];
        GraphRepo [label="GraphRepository", shape=cylinder, style="filled", fillcolor=white];
        UtteranceRepo [label="UtteranceRepository", shape=cylinder, style="filled", fillcolor=white];
    }

    subgraph cluster_services {
        label="Business Services (Injected)";
        style=filled;
        color=lavender;
        ExtractionSvc [label="ExtractionService", shape=component, style="filled", fillcolor=white];
        GraphSvc [label="GraphService", shape=component, style="filled", fillcolor=white];
        StrategySvc [label="StrategyService", shape=component, style="filled", fillcolor=white];
        QuestionSvc [label="QuestionService", shape=component, style="filled", fillcolor=white"];
    }

    subgraph cluster_context {
        label="TurnContext (Data Flow)";
        style=filled;
        color=lightgrey;
        Context [label="TurnContext\n◇ session_id\n◇ user_input\n◇ extraction\n◇ graph_state\n◇ strategy\n◇ next_question", shape=folder, style="filled", fillcolor=white];
    }

    // Flow edges
    API -> SessionService [label="POST /turns", penwidth=2];
    SessionService -> Pipeline [label="delegate", penwidth=2];
    Pipeline -> Stage1 [penwidth=2];
    Stage1 -> Stage2 [style=dotted, label="context"];
    Stage2 -> Stage3 [style=dotted, label="context"];
    Stage3 -> Stage4 [style=dotted, label="context"];
    Stage4 -> Stage5 [style=dotted, label="context"];
    Stage5 -> Stage6 [style=dotted, label="context"];
    Stage6 -> Stage7 [style=dotted, label="context"];
    Stage7 -> Stage8 [style=dotted, label="context"];
    Stage8 -> Stage9 [style=dotted, label="context"];
    Stage9 -> Stage10 [style=dotted, label="context"];

    // Dependency edges (dashed = loose coupling)
    Stage1 -> SessionRepo [style=dashed, label="read", color=darkred];
    Stage2 -> UtteranceRepo [style=dashed, label="save", color=darkred];
    Stage3 -> ExtractionSvc [style=dashed, label="use", color=darkgreen];
    Stage4 -> GraphSvc [style=dashed, label="use", color=darkgreen];
    Stage5 -> GraphSvc [style=dashed, label="use", color=darkgreen];
    Stage6 -> StrategySvc [style=dashed, label="use", color=darkgreen];
    Stage8 -> QuestionSvc [style=dashed, label="use", color=darkgreen];
    Stage9 -> UtteranceRepo [style=dashed, label="save", color=darkred];
    Stage4 -> GraphRepo [style=dashed, label="update", color=darkred];
    Stage10 -> SessionRepo [style=dashed, label="save", color=darkred];

    // Context flows through pipeline
    Context -> Stage1 [style=invisible];
    Stage10 -> Context [style=invisible, label="returns\nTurnResult"];

    // Legend
    subgraph cluster_legend {
        label="Legend";
        rank=sink;
        style=dashed;
        LegendAPI [label="API Call", shape=box, style=filled, fillcolor=lightblue];
        LegendStage [label="Pipeline Stage", shape=note, style=filled, fillcolor=lightcyan];
        LegendRepo [label="Repository", shape=cylinder, style=filled, fillcolor=lightcoral];
        LegendSvc [label="Service", shape=component, style=filled, fillcolor=lavender];
        LegendContext [label="TurnContext", shape=folder, style=filled, fillcolor=white];
    }
}
