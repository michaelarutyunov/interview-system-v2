# Two-tier scoring system configuration
#
# Tier 1: Hard constraints (boolean vetoes)
# - Early exit on first veto
# - No weights, all equal veto power
#
# Tier 2: Weighted additive scoring
# - Weights must sum to 1.0
# - Scores in range [0, 2] with 1.0 as neutral

scoring:
  # Tier 1 scorers (hard constraints)
  # Process-management strategies (closing, ease, reflection, clarify) are exempt from all vetoes
  tier1_scorers:
    - id: knowledge_ceiling
      class: KnowledgeCeilingScorer
      enabled: true
      params:
        min_confidence: 0.5
        use_llm_signals: true
        negative_patterns:
          - "don't know"
          - "not sure"
          - "never heard"
          - "no idea"
          - "unfamiliar"
        # Consecutive terminal response tracking (consolidated from ConsecutiveExhaustionScorer)
        consecutive_terminal_threshold: 3  # Number of consecutive terminal responses before veto
        # Strategies that manage interview process (never vetoed)
        exempt_strategies:
          - closing
          - ease
          - reflection
          - clarify

    - id: element_exhausted
      class: ElementExhaustedScorer
      enabled: true
      params:
        max_mentions: 5
        lookback_window: 10
        # Strategies that manage interview process (never vetoed)
        exempt_strategies:
          - closing
          - ease
          - reflection
          - clarify

    - id: recent_redundancy
      class: RecentRedundancyScorer
      enabled: true
      params:
        similarity_threshold: 0.85
        lookback_window: 6
        method: "tfidf_cosine"  # jaccard, cosine, or embeddings
        # Strategies that manage interview process (never vetoed)
        exempt_strategies:
          - closing
          - ease
          - reflection
          - clarify

    - id: clarification_veto
      class: ClarificationVetoScorer
      enabled: true
      params:
        severity_threshold: 0.3  # Minimum severity to trigger veto
        vetoed_strategies:
          - deepen
          - broaden
          - bridge
        use_llm_signals: true
        # Strategies that manage interview process (never vetoed)
        # Note: clarify is exempt from its own veto (idempotent)
        exempt_strategies:
          - closing
          - ease
          - reflection
          - clarify

  # Tier 2 scorers (weighted additive)
  # Weights rebalanced to sum to 1.0 (was 1.45, causing score inflation)
  tier2_scorers:
    - id: coverage_gap
      class: CoverageGapScorer
      enabled: true
      weight: 0.14
      params:
        gap_types:
          - "unmentioned"
          - "no_reaction"
          - "no_comprehension"
          - "unconnected"
        boost_per_gap: 0.15

    - id: ambiguity
      class: AmbiguityScorer
      enabled: true
      weight: 0.10
      params:
        high_clarity_threshold: 0.8
        low_clarity_threshold: 0.5
        hedge_words:
          - "maybe"
          - "perhaps"
          - "possibly"
          - "sort of"
          - "kind of"
          - "i think"
          - "i guess"
          - "probably"
          - "not sure"
        use_llm_signals: true

    - id: depth_breadth_balance
      class: DepthBreadthBalanceScorer
      enabled: true
      weight: 0.14
      params:
        target_ratio: 0.5  # 0.5 = balanced, 0.7 = depth-favoring
        low_breadth_threshold: 0.4
        high_breadth_threshold: 0.7
        low_depth_threshold: 2.0
        high_depth_threshold: 4.0

    - id: engagement
      class: EngagementScorer
      enabled: true
      weight: 0.10
      params:
        low_momentum_threshold: 30
        high_momentum_threshold: 100
        elaboration_markers:
          - "because"
          - "since"
          - "for example"
          - "specifically"
          - "such as"
          - "meaning"
        enthusiasm_markers:
          - "!"
          - "really"
          - "absolutely"
          - "love"
          - "great"
          - "perfect"

    - id: strategy_diversity
      class: StrategyDiversityScorer
      enabled: true
      weight: 0.10
      params:
        lookback_window: 5
        moderate_use_threshold: 2
        overuse_threshold: 3
        moderate_penalty: 0.8
        overuse_penalty: 0.6

    - id: novelty
      class: NoveltyScorer
      enabled: true
      weight: 0.10
      params:
        lookback_window: 8
        fresh_threshold: 1
        overdiscussed_threshold: 4
        fresh_boost: 1.2
        overdiscussed_penalty: 0.7

    - id: saturation
      class: SaturationScorer
      enabled: true
      weight: 0.10
      params:
        chao1_threshold: 0.90
        new_info_threshold: 0.05
        run_length: 2
        saturated_penalty: 0.7
        breadth_boost: 1.5

    - id: cluster_saturation
      class: ClusterSaturationScorer
      enabled: true
      weight: 0.07
      params:
        high_saturation_threshold: 0.7
        moderate_saturation_threshold: 0.4

    - id: contrast_opportunity
      class: ContrastOpportunityScorer
      enabled: true
      weight: 0.07
      params:
        high_density_threshold: 0.6

    - id: peripheral_readiness
      class: PeripheralReadinessScorer
      enabled: true
      weight: 0.08
      params:
        high_density_threshold: 0.7
        moderate_density_threshold: 0.5
        min_peripheral_count: 3
        any_peripheral_count: 1

  # Validation rules
  validation:
    tier2_weights_must_sum_to: 1.0
    tolerance: 0.01
    require_at_least_one_tier1: false  # Tier 1 optional for now
    warn_if_tier1_veto_rate_exceeds: 0.8

# Strategy definitions
strategies:
  - id: deepen
    name: "Deepen Understanding"
    type_category: "depth"
    priority_base: 1.0
    enabled: true
    prompt_hint: "Explore deeper into why this is important."

  - id: broaden
    name: "Explore Breadth"
    type_category: "breadth"
    priority_base: 0.9
    enabled: true
    prompt_hint: "Expand to related areas or perspectives."

  - id: cover_element
    name: "Cover Stimulus Element"
    type_category: "coverage"
    priority_base: 1.1
    enabled: true
    prompt_hint: "Ensure this element from the stimulus is addressed."

  - id: closing
    name: "Closing Interview"
    type_category: "closing"
    priority_base: 0.5  # Lower base - only use when appropriate
    enabled: true
    prompt_hint: "Begin to wrap up the interview."
    # Note: Phase system controls timing via phase multipliers (no min_turns needed)

  - id: reflection
    name: "Reflection / Meta-Question"
    type_category: "reflection"
    priority_base: 0.7  # Emergency fallback
    enabled: true
    prompt_hint: "Ask a meta-question about the interview process."
    emergency_only: true  # Only when all else fails

  - id: bridge
    name: "Lateral Bridge to Peripheral"
    type_category: "peripheral"
    priority_base: 0.8
    enabled: true
    prompt_hint: "Explicitly link to what was just said, then gently shift to a related but distinct area."

  - id: contrast
    name: "Introduce Counter-Example"
    type_category: "contrast"
    priority_base: 0.7
    enabled: true
    prompt_hint: "Politely introduce a counter-example or opposite case to test boundaries."

  - id: ease
    name: "Ease / Rapport Repair"
    type_category: "interaction"
    priority_base: 0.6
    enabled: true
    prompt_hint: "Simplify or soften the question, encourage participation."

  - id: synthesis
    name: "Summarise & Invite Extension"
    type_category: "transition"
    priority_base: 0.8
    enabled: true
    prompt_hint: "Briefly summarise what you've heard and invite correction or addition."

  - id: clarify
    name: "Clarify / Rephrase"
    type_category: "clarification"
    priority_base: 0.5
    enabled: true
    prompt_hint: "Rephrase the question in simpler terms when user shows confusion."
    emergency_only: false

# Phase profiles
phase_profiles:
  exploratory:
    deepen: 0.8
    broaden: 1.2
    cover_element: 1.1
    bridge: 0.2
    contrast: 0.0
    synthesis: 0.3
    closing: 0.0
    ease: 1.0
    reflection: 0.3
    clarify: 0.5

  focused:
    deepen: 1.3
    broaden: 0.4
    cover_element: 1.1
    bridge: 1.0
    contrast: 1.2
    synthesis: 0.7
    closing: 0.5
    ease: 1.0
    reflection: 0.7
    clarify: 0.5

  closing:
    deepen: 0.3
    broaden: 0.2
    cover_element: 0.5
    bridge: 0.3
    contrast: 0.5
    synthesis: 1.2
    closing: 1.5
    ease: 1.0
    reflection: 0.3
    clarify: 0.3

# Engine configuration
engine:
  veto_on_first: true  # Stop Tier 1 evaluation on first veto
  score_precision: 4   # Decimal places for score display
  alternatives_count: 3  # Number of alternatives to track
  alternatives_min_score: 0.3  # Minimum score for alternatives
