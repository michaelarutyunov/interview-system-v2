# Spec 1.7: Session API Endpoints

## Objective
Create FastAPI endpoints for session management: create session, get session by ID, delete session, and list active sessions.

## Context
- Reference: IMPLEMENTATION_PLAN.md Section 2.2 (Task 1.7)
- Part of Phase 1 deliverable: `POST /sessions`, `GET /sessions/{id}`, `DELETE /sessions/{id}`
- Follows FastAPI patterns from Engineering Guide
- Uses SessionRepository from Spec 1.6

## Input Files
- `IMPLEMENTATION_PLAN.md` - Task 1.7 description
- `PRD` - API specification for sessions
- `src/persistence/repositories/session_repo.py` - From Spec 1.6

## Output Files

### FastAPI Routes
Create `src/api/routes/sessions.py`:
```python
"""Session API endpoints."""
from fastapi import APIRouter, HTTPException, status
from src.domain.models.session import Session, SessionState
from src.persistence.repositories.session_repo import SessionRepository
from src.core.exceptions import NotFoundError


router = APIRouter(prefix="/sessions", tags=["sessions"])


@router.post("/", response_model=Session)
async def create_session(
    methodology: str,
    concept_id: str,
    concept_name: str,
    session_repo: SessionRepository
) -> Session:
    """Create a new interview session."""
    import uuid
    from datetime import datetime

    session_id = str(uuid.uuid4())
    session = Session(
        id=session_id,
        methodology=methodology,
        concept_id=concept_id,
        concept_name=concept_name,
        created_at=datetime.utcnow(),
        updated_at=datetime.utcnow(),
        status="active",
        state=SessionState(
            methodology=methodology,
            concept_id=concept_id,
            concept_name=concept_name,
            turn_count=0,
            coverage_score=0.0
        )
    )
    return await session_repo.create(session)


@router.get("/{session_id}", response_model=Session)
async def get_session(
    session_id: str,
    session_repo: SessionRepository
) -> Session:
    """Get a session by ID. Returns 404 if not found."""
    session = await session_repo.get(session_id)
    if not session:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Session {session_id} not found"
        )
    return session


@router.delete("/{session_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_session(
    session_id: str,
    session_repo: SessionRepository
):
    """Delete a session by ID. Returns 404 if not found."""
    deleted = await session_repo.delete(session_id)
    if not deleted:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Session {session_id} not found"
        )


@router.get("/", response_model=list[Session])
async def list_sessions(
    session_repo: SessionRepository
) -> list[Session]:
    """List all active sessions."""
    return await session_repo.list_active()
```

### Update Main App
Update `src/main.py` to include the sessions router:
```python
from src.api.routes import sessions

app.include_router(sessions.router)
```

## Requirements

1. FastAPI router uses async/await for all database operations
2. Uses dependency injection for SessionRepository
3. Proper error handling with appropriate HTTP status codes
4. Response models use Pydantic for serialization
5. Follows FastAPI best practices from Engineering Guide

## Verification
```bash
# Check prerequisites
command -v python3 >/dev/null 2>&1 || pip3 install python3
python3 -c "import fastapi" 2>/dev/null || pip3 install fastapi
python3 -c "import aiosqlite" 2>/dev/null || pip3 install aiosqlite

# Run tests
pytest tests/integration/test_sessions_api.py -v
```

## Manual Verification
```bash
# Start server
uvicorn src.main:app --reload

# In another terminal:
# Create session
curl -X POST "http://localhost:8000/sessions" \
  -H "Content-Type: application/json" \
  -d '{"methodology": "mec", "concept_id": "test", "concept_name": "Test"}'

# Get session
curl "http://localhost:8000/sessions/{session_id}"

# List sessions
curl "http://localhost:8000/sessions/"

# Delete session
curl -X DELETE "http://localhost:8000/sessions/{session_id}"
```

## Success Criteria
- [ ] POST /sessions creates a new session and returns Session object
- [ ] GET /sessions/{id} returns session or 404 if not found
- [ ] DELETE /sessions/{id} deletes session or returns 404 if not found
- [ ] GET /sessions returns list of active sessions
- [ ] All endpoints handle errors with appropriate HTTP status codes
- [ ] Integration tests pass for all endpoints

## Dependencies
- Requires: SessionRepository from Spec 1.6
- Requires: FastAPI app shell from Spec 1.5
- Tested by: Spec 1.8 (Integration test)
