# Spec 1.5: FastAPI Application Shell

## Objective
Create the FastAPI application entry point with health endpoint and startup/shutdown hooks.

## Context
- Reference: ENGINEERING_GUIDE.md Section 3 (main.py)
- Reference: PRD.md Section 8.5 (GET /health)

## Input Files
- `ENGINEERING_GUIDE.md` - Application structure
- `PRD.md` - API specification

## Output Files

### src/main.py
```python
"""
FastAPI application entry point.

Run with: uvicorn src.main:app --reload
"""

from contextlib import asynccontextmanager

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import structlog

from src.core.config import settings
from src.core.logging import configure_logging, get_logger
from src.persistence.database import init_database, check_database_health
from src.api.routes import health

# Configure logging before anything else
configure_logging()
log = get_logger(__name__)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    Application lifespan manager.
    
    Handles startup and shutdown events.
    """
    # Startup
    log.info(
        "application_starting",
        debug=settings.debug,
        database_path=str(settings.database_path)
    )
    
    # Initialize database
    await init_database()
    
    log.info("application_started")
    
    yield
    
    # Shutdown
    log.info("application_shutting_down")


# Create FastAPI application
app = FastAPI(
    title="Interview System v2",
    description="Adaptive interview system for qualitative consumer research",
    version="0.1.0",
    lifespan=lifespan,
    debug=settings.debug,
)

# CORS middleware for development
if settings.debug:
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

# Include routers
app.include_router(health.router, tags=["system"])


# Root endpoint
@app.get("/")
async def root():
    """Root endpoint with basic info."""
    return {
        "name": "Interview System v2",
        "version": "0.1.0",
        "status": "running"
    }


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "src.main:app",
        host=settings.host,
        port=settings.port,
        reload=settings.debug,
    )
```

### src/api/__init__.py
```python
"""API layer."""
# noqa
```

### src/api/routes/__init__.py
```python
"""API route modules."""
# noqa
```

### src/api/routes/health.py
```python
"""
Health check endpoints.

Provides system health information for monitoring.
"""

from fastapi import APIRouter
import structlog

from src.core.config import settings
from src.persistence.database import check_database_health

log = structlog.get_logger(__name__)

router = APIRouter()


@router.get("/health")
async def health_check():
    """
    Health check endpoint.
    
    Returns:
        System health status including database connectivity.
    """
    db_health = await check_database_health()
    
    overall_status = "healthy" if db_health["status"] == "healthy" else "unhealthy"
    
    return {
        "status": overall_status,
        "version": "0.1.0",
        "debug": settings.debug,
        "components": {
            "database": db_health
        }
    }


@router.get("/health/live")
async def liveness():
    """
    Kubernetes-style liveness probe.
    
    Returns 200 if the application is running.
    """
    return {"status": "alive"}


@router.get("/health/ready")
async def readiness():
    """
    Kubernetes-style readiness probe.
    
    Returns 200 if the application is ready to serve requests.
    """
    db_health = await check_database_health()
    
    if db_health["status"] != "healthy":
        from fastapi import HTTPException
        raise HTTPException(status_code=503, detail="Database not ready")
    
    return {"status": "ready"}
```

### tests/integration/test_api.py
```python
"""Integration tests for API endpoints."""

import pytest
from httpx import AsyncClient, ASGITransport
import tempfile
from pathlib import Path


@pytest.fixture
def test_db_path():
    """Create a temporary database path."""
    with tempfile.TemporaryDirectory() as tmpdir:
        yield Path(tmpdir) / "test.db"


@pytest.fixture
def app_with_test_db(test_db_path):
    """Create app with test database."""
    from src.core import config
    
    # Override database path
    original_path = config.settings.database_path
    config.settings.database_path = test_db_path
    
    # Import app after overriding settings
    from src.main import app
    
    yield app
    
    # Restore original path
    config.settings.database_path = original_path


@pytest.mark.asyncio
async def test_root_endpoint(app_with_test_db):
    """Root endpoint returns basic info."""
    transport = ASGITransport(app=app_with_test_db)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        response = await client.get("/")
    
    assert response.status_code == 200
    data = response.json()
    assert data["name"] == "Interview System v2"
    assert data["status"] == "running"


@pytest.mark.asyncio
async def test_health_endpoint(app_with_test_db):
    """Health endpoint returns system status."""
    # Initialize database first
    from src.persistence.database import init_database
    from src.core.config import settings
    await init_database(settings.database_path)
    
    transport = ASGITransport(app=app_with_test_db)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        response = await client.get("/health")
    
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "healthy"
    assert "components" in data
    assert "database" in data["components"]


@pytest.mark.asyncio
async def test_liveness_endpoint(app_with_test_db):
    """Liveness probe returns alive status."""
    transport = ASGITransport(app=app_with_test_db)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        response = await client.get("/health/live")
    
    assert response.status_code == 200
    assert response.json()["status"] == "alive"


@pytest.mark.asyncio
async def test_readiness_endpoint(app_with_test_db):
    """Readiness probe checks database."""
    from src.persistence.database import init_database
    from src.core.config import settings
    await init_database(settings.database_path)
    
    transport = ASGITransport(app=app_with_test_db)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        response = await client.get("/health/ready")
    
    assert response.status_code == 200
    assert response.json()["status"] == "ready"
```

## Requirements
1. FastAPI app must use lifespan context manager for startup/shutdown
2. Database must be initialized on startup
3. Logging must be configured before app creation
4. Health endpoint must check database connectivity
5. CORS must be enabled in debug mode only
6. All tests must pass

## Verification
```bash
# Assumes running from project root - no cd needed

# Check prerequisites
command -v pytest >/dev/null 2>&1 || pip3 install pytest pytest-asyncio
command -v uvicorn >/dev/null 2>&1 || pip3 install uvicorn[standard]
command -v curl >/dev/null 2>&1 || { echo "âŒ curl not installed. Install with: apt install curl / brew install curl"; exit 1; }

# Run the tests
pytest tests/integration/test_api.py -v

# Manual verification: start the server
uvicorn src.main:app --reload

# In another terminal:
curl http://localhost:8000/
curl http://localhost:8000/health
curl http://localhost:8000/health/live
curl http://localhost:8000/health/ready

# Expected responses:
# / -> {"name": "Interview System v2", ...}
# /health -> {"status": "healthy", ...}
# /health/live -> {"status": "alive"}
# /health/ready -> {"status": "ready"}
```

## Success Criteria
- [ ] `uvicorn src.main:app --reload` starts without errors
- [ ] `/` returns application info
- [ ] `/health` returns healthy status with database info
- [ ] `/health/live` returns alive
- [ ] `/health/ready` returns ready (after database init)
- [ ] All tests pass
