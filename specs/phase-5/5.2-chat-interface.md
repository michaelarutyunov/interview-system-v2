# Spec 5.2: Chat Interface

## Objective
Create the chat interface component for the Streamlit demo UI.

## Context
- Reference: v1 `src/ui/components/chat_interface.py`
- Streamlit's `st.chat_message` and `st.chat_input` for chat UI
- Calls FastAPI `/sessions/{id}/turns` endpoint
- Displays interview conversation history
- Shows opening question and follow-up questions

## Input Files
- `docs/ui-framework-decision.md` - Framework choice (Streamlit)
- Phase 1: `src/api/routes/sessions.py` - Session API endpoints
- v1: `/home/mikhailarutyunov/projects/graph-enabled-ai-interviewer/src/ui/components/chat_interface.py`

## Output Files

### ui/api_client.py
```python
"""
API client for communicating with FastAPI backend.

Provides async HTTP calls to all backend endpoints.
Handles session management, error handling, and response parsing.
"""

from typing import Optional, Dict, Any, List
from dataclasses import dataclass

import httpx


@dataclass
class SessionInfo:
    """Information about an interview session."""
    id: str
    concept_id: str
    status: str
    opening_question: Optional[str] = None
    created_at: Optional[str] = None


class APIClient:
    """
    Client for making HTTP requests to the FastAPI backend.
    
    Usage:
        client = APIClient(base_url="http://localhost:8000")
        session = await client.create_session("oat_milk_v1")
        result = await client.submit_turn(session.id, "I like it")
    """
    
    def __init__(self, base_url: str = "http://localhost:8000", timeout: float = 30.0):
        """
        Initialize API client.
        
        Args:
            base_url: Base URL of FastAPI backend
            timeout: Request timeout in seconds
        """
        self.base_url = base_url.rstrip("/")
        self.timeout = timeout
        self._client: Optional[httpx.AsyncClient] = None
    
    async def __aenter__(self):
        """Async context manager entry."""
        self._client = httpx.AsyncClient(timeout=self.timeout)
        return self
    
    async def __aexit__(self, *args):
        """Async context manager exit."""
        if self._client:
            await self._client.aclose()
    
    def _get_client(self) -> httpx.AsyncClient:
        """Get or create HTTP client."""
        if self._client is None:
            self._client = httpx.AsyncClient(timeout=self.timeout)
        return self._client
    
    async def create_session(
        self,
        concept_id: str,
        max_turns: int = 20,
        target_coverage: float = 0.8,
    ) -> SessionInfo:
        """
        Create a new interview session.
        
        Args:
            concept_id: Concept configuration ID
            max_turns: Maximum turns for session
            target_coverage: Target coverage threshold
        
        Returns:
            SessionInfo with session details
        
        Raises:
            httpx.HTTPError: On API errors
        """
        client = self._get_client()
        response = await client.post(
            f"{self.base_url}/sessions",
            json={
                "concept_id": concept_id,
                "max_turns": max_turns,
                "target_coverage": target_coverage,
            },
        )
        response.raise_for_status()
        data = response.json()
        
        return SessionInfo(
            id=data["id"],
            concept_id=data["concept_id"],
            status=data["status"],
            opening_question=data.get("opening_question"),
            created_at=data.get("created_at"),
        )
    
    async def submit_turn(
        self,
        session_id: str,
        user_input: str,
    ) -> Dict[str, Any]:
        """
        Submit a turn to the session.
        
        Args:
            session_id: Session ID
            user_input: User's response text
        
        Returns:
            Turn result dict with next_question, extracted, scoring, etc.
        """
        client = self._get_client()
        response = await client.post(
            f"{self.base_url}/sessions/{session_id}/turns",
            json={"user_input": user_input},
        )
        response.raise_for_status()
        return response.json()
    
    async def get_session_status(self, session_id: str) -> Dict[str, Any]:
        """Get current session status."""
        client = self._get_client()
        response = await client.get(f"{self.base_url}/sessions/{session_id}/status")
        response.raise_for_status()
        return response.json()
    
    async def get_session_graph(self, session_id: str) -> Dict[str, Any]:
        """Get session knowledge graph."""
        client = self._get_client()
        response = await client.get(f"{self.base_url}/sessions/{session_id}/graph")
        response.raise_for_status()
        return response.json()
    
    async def list_sessions(self) -> List[Dict[str, Any]]:
        """List all sessions."""
        client = self._get_client()
        response = await client.get(f"{self.base_url}/sessions")
        response.raise_for_status()
        return response.json()
    
    async def close(self):
        """Close the HTTP client."""
        if self._client:
            await self._client.aclose()
            self._client = None
```

### ui/components/chat.py
```python
"""
Chat interface component for Streamlit demo UI.

Provides chat message display and input using Streamlit's chat components.
Integrates with FastAPI backend for turn processing.
"""

from typing import List, Dict, Any, Optional, Tuple
import streamlit as st

from ui.api_client import APIClient, SessionInfo


class ChatInterface:
    """
    Manages the chat interface for interview conversations.
    
    Displays:
    - Opening question
    - Chat history (user/assistant messages)
    - Chat input for user responses
    """
    
    def __init__(self, api_client: APIClient):
        """
        Initialize chat interface.
        
        Args:
            api_client: API client for backend communication
        """
        self.api_client = api_client
        self.max_history = 100
    
    def render(self, session_info: Optional[SessionInfo]) -> Optional[str]:
        """
        Render the chat interface.
        
        Args:
            session_info: Current session info (or None)
        
        Returns:
            User input text if submitted, None otherwise
        """
        st.subheader("ðŸ’¬ Interview Chat")
        
        if not session_info:
            st.info("ðŸ‘‹ Create or select a session to start the interview.")
            return None
        
        # Display opening question if available
        if session_info.opening_question:
            self._display_opening_question(session_info.opening_question)
        
        # Display chat history
        self._display_chat_history()
        
        # Chat input
        user_input = st.chat_input("Your response...")
        
        if user_input:
            # Add user message to history
            st.session_state.chat_history.append({
                "role": "user",
                "content": user_input
            })
        
        return user_input if user_input else None
    
    def _display_opening_question(self, question: str):
        """Display the opening question."""
        if "opening_displayed" not in st.session_state:
            with st.chat_message("assistant"):
                st.write(question)
            st.session_state.opening_displayed = True
            st.session_state.chat_history = [{
                "role": "assistant",
                "content": question
            }]
    
    def _display_chat_history(self):
        """Display the chat history."""
        if "chat_history" not in st.session_state:
            st.session_state.chat_history = []
        
        for message in st.session_state.chat_history:
            with st.chat_message(message["role"]):
                st.write(message["content"])
    
    def add_assistant_message(self, content: str):
        """
        Add an assistant message to the chat history.
        
        Args:
            content: Assistant's response/question
        """
        if "chat_history" not in st.session_state:
            st.session_state.chat_history = []
        
        st.session_state.chat_history.append({
            "role": "assistant",
            "content": content
        })
        
        # Trim history if needed
        if len(st.session_state.chat_history) > self.max_history:
            st.session_state.chat_history = st.session_state.chat_history[-self.max_history:]
    
    def clear_history(self):
        """Clear the chat history."""
        st.session_state.chat_history = []
        if "opening_displayed" in st.session_state:
            del st.session_state.opening_displayed
    
    def get_history(self) -> List[Dict[str, str]]:
        """
        Get the current chat history.
        
        Returns:
            List of message dicts with 'role' and 'content'
        """
        return st.session_state.get("chat_history", [])


def initialize_chat_state():
    """Initialize chat-related session state variables."""
    if "chat_history" not in st.session_state:
        st.session_state.chat_history = []
    if "opening_displayed" not in st.session_state:
        st.session_state.opening_displayed = False
```

## Requirements
1. Use Streamlit's `st.chat_message` and `st.chat_input`
2. Async API client using httpx
3. Session state management for chat history
4. Display opening question
5. Handle empty session state gracefully

## Verification
```bash
# Run tests
python3 -c "
from ui.api_client import APIClient, SessionInfo
from ui.components.chat import ChatInterface, initialize_chat_state
print('Components imported successfully')
"

# Verify Streamlit app structure
python3 -c "
import streamlit as st
print(f'Streamlit version: {st.__version__}')
"
```

## Success Criteria
- [ ] `ui/api_client.py` created with APIClient class
- [ ] `ui/components/chat.py` created with ChatInterface class
- [ ] `APIClient.create_session()` - creates session via API
- [ ] `APIClient.submit_turn()` - submits turn via API
- [ ] `ChatInterface.render()` - displays chat UI
- [ ] `ChatInterface.add_assistant_message()` - adds AI response
- [ ] Chat history managed in session state
- [ ] Components import without errors
