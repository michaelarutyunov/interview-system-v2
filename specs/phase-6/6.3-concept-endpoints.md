# Spec 6.3: Concept Endpoints

## Objective
Create API endpoints for concept configuration management.

## Context
- Reference: PRD Section 8.3 (Concepts)
- List available concepts
- Get concept details
- Upload new concept configurations (future)

## Input Files
- Phase 1: `src/api/routes/sessions.py` - Reference for route patterns
- config/concepts/ - Concept configuration YAML files

## Output Files

### src/api/routes/concepts.py
```python
"""
API routes for concept configuration management.

GET /concepts - List available concepts
GET /concepts/{id} - Get concept details
"""

from typing import List, Dict, Any, Optional
from pathlib import Path

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field

import structlog

from src.core.config import settings


log = structlog.get_logger(__name__)
router = APIRouter(prefix="/concepts", tags=["concepts"])


# Response Models
class ConceptElement(BaseModel):
    """Single element in a concept configuration."""
    id: str = Field(description="Element identifier")
    label: str = Field(description="Display label")
    type: str = Field(description="Element type (attribute, consequence, etc.)")
    priority: str = Field(description="Priority level (high, medium, low)")


class ConceptCompletion(BaseModel):
    """Completion criteria for a concept."""
    target_coverage: float = Field(description="Target coverage threshold")
    max_turns: int = Field(description="Maximum turns")
    saturation_threshold: float = Field(description="Saturation threshold")


class ConceptConfig(BaseModel):
    """Concept configuration."""
    id: str = Field(description="Concept ID")
    name: str = Field(description="Concept name")
    description: Optional[str] = Field(default="", description="Description")
    methodology: str = Field(description="Methodology ID")
    elements: List[ConceptElement] = Field(default_factory=list, description="Concept elements")
    completion: ConceptConfig = Field(description="Completion criteria")


class ConceptListItem(BaseModel):
    """Item in concept list."""
    id: str
    name: str
    methodology: str
    element_count: int


def _load_concepts_from_config() -> List[Dict[str, Any]]:
    """
    Load concepts from configuration directory.
    
    Returns:
        List of concept configuration dicts
    """
    concepts_dir = settings.config_dir / "concepts"
    
    if not concepts_dir.exists():
        log.warning("concepts_directory_not_found", path=str(concepts_dir))
        return []
    
    concepts = []
    
    for yaml_file in concepts_dir.glob("*.yaml"):
        try:
            import yaml
            with open(yaml_file) as f:
                data = yaml.safe_load(f)
                if data:
                    concepts.append(data)
        except Exception as e:
            log.warning(
                "concept_load_failed",
                file=str(yaml_file),
                error=str(e),
            )
    
    log.info("concepts_loaded", count=len(concepts))
    return concepts


# Routes
@router.get(
    "",
    response_model=List[ConceptListItem],
    summary="List available concepts",
    description="Get list of all available concept configurations",
)
async def list_concepts() -> List[ConceptListItem]:
    """
    List all available concept configurations.
    
    Returns:
        List of concept summaries
    """
    concepts = _load_concepts_from_config()
    
    return [
        ConceptListItem(
            id=c["id"],
            name=c["name"],
            methodology=c["methodology"],
            element_count=len(c.get("elements", [])),
        )
        for c in concepts
    ]


@router.get(
    "/{concept_id}",
    response_model=ConceptConfig,
    summary="Get concept details",
    description="Get full configuration for a specific concept",
)
async def get_concept(concept_id: str) -> ConceptConfig:
    """
    Get detailed concept configuration.
    
    Args:
        concept_id: Concept identifier
    
    Returns:
        Full concept configuration
    
    Raises:
        HTTPException 404: If concept not found
    """
    concepts = _load_concepts_from_config()
    
    # Find concept by ID
    concept_data = next((c for c in concepts if c["id"] == concept_id), None)
    
    if not concept_data:
        log.warning("concept_not_found", concept_id=concept_id)
        raise HTTPException(
            status_code=404,
            detail=f"Concept '{concept_id}' not found",
        )
    
    log.info("concept_retrieved", concept_id=concept_id)
    
    return ConceptConfig(**concept_data)


@router.get(
    "/{concept_id}/elements",
    response_model=List[ConceptElement],
    summary="Get concept elements",
    description="Get elements for a specific concept",
)
async def get_concept_elements(concept_id: str) -> List[ConceptElement]:
    """
    Get elements for a concept configuration.
    
    Args:
        concept_id: Concept identifier
    
    Returns:
        List of concept elements
    
    Raises:
        HTTPException 404: If concept not found
    """
    concepts = _load_concepts_from_config()
    
    concept_data = next((c for c in concepts if c["id"] == concept_id), None)
    
    if not concept_data:
        raise HTTPException(
            status_code=404,
            detail=f"Concept '{concept_id}' not found",
        )
    
    elements = concept_data.get("elements", [])
    
    return [
        ConceptElement(
            id=e["id"],
            label=e["label"],
            type=e["type"],
            priority=e.get("priority", "medium"),
        )
        for e in elements
    ]
```

### config/concepts/oat_milk.yaml (example if not exists)
```yaml
id: oat_milk_v1
name: "Oat Milk"
description: "Plant-based milk alternative made from oats"
methodology: means_end_chain

elements:
  - id: creamy_texture
    label: "Creamy texture"
    type: attribute
    priority: high
    
  - id: plant_based
    label: "Plant-based / dairy-free"
    type: attribute
    priority: high
    
  - id: sustainable
    label: "Environmentally sustainable"
    type: attribute
    priority: medium
    
  - id: froths_well
    label: "Froths well for coffee"
    type: attribute
    priority: medium
    
  - id: neutral_taste
    label: "Neutral/mild taste"
    type: attribute
    priority: low
    
  - id: nutritional
    label: "Nutritional profile"
    type: attribute
    priority: low

completion:
  target_coverage: 0.8
  max_turns: 20
  saturation_threshold: 0.05
```

### tests/integration/test_concepts_api.py
```python
"""Integration tests for concepts API endpoints."""

import pytest
from httpx import AsyncClient

from src.main import app


class TestConceptsEndpoints:
    """Tests for concept endpoints."""
    
    @pytest.mark.asyncio
    async def test_list_concepts(self):
        """GET /concepts returns list of concepts."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get("/concepts")
            
            assert response.status_code == 200
            data = response.json()
            assert isinstance(data, list)
    
    @pytest.mark.asyncio
    async def test_get_concept_details(self):
        """GET /concepts/{id} returns concept details."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get("/concepts/oat_milk_v1")
            
            # May return 404 if concept doesn't exist
            # In real test, would set up concept file first
            assert response.status_code in [200, 404]
    
    @pytest.mark.asyncio
    async def test_get_concept_not_found(self):
        """GET /concepts/{id} returns 404 for unknown concept."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get("/concepts/unknown_concept")
            
            assert response.status_code == 404
    
    @pytest.mark.asyncio
    async def test_get_concept_elements(self):
        """GET /concepts/{id}/elements returns concept elements."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get("/concepts/oat_milk_v1/elements")
            
            # May return 404 if concept doesn't exist
            assert response.status_code in [200, 404]
```

## Requirements
1. GET /concepts - lists all available concepts
2. GET /concepts/{id} - returns concept details
3. GET /concepts/{id}/elements - returns concept elements
4. Loads from config/concepts/*.yaml
5. Returns 404 for unknown concepts
6. Proper response models with Pydantic

## Verification
```bash
# Run tests
pytest tests/integration/test_concepts_api.py -v

# Test endpoints with running server
curl http://localhost:8000/concepts
curl http://localhost:8000/concepts/oat_milk_v1
curl http://localhost:8000/concepts/oat_milk_v1/elements
```

## Success Criteria
- [ ] `src/api/routes/concepts.py` created
- [ ] GET /concepts endpoint lists concepts
- [ ] GET /concepts/{id} returns concept details
- [ ] GET /concepts/{id}/elements returns elements
- [ ] Concepts loaded from YAML files
- [ ] 404 returned for unknown concepts
- [ ] Integration tests pass
