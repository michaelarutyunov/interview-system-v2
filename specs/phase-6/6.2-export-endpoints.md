# Spec 6.2: Export Endpoints

## Objective
Create API endpoints for session data export.

## Context
- Reference: PRD Section 8.2 (Monitoring & Export)
- Endpoint: `GET /sessions/{id}/export?format=json|markdown|csv`
- Returns exported data with appropriate content-type
- Integrates with ExportService from 6.1

## Input Files
- Phase 6.1: `src/services/export_service.py` - Export service
- Phase 1: `src/api/routes/sessions.py` - Existing session routes

## Output Files

### src/api/routes/sessions.py (additions)
```python
# Add to existing src/api/routes/sessions.py

from typing import Optional
from fastapi import APIRouter, HTTPException, Depends, Query
from fastapi.responses import Response, PlainTextResponse

import structlog

from src.services.export_service import ExportService
from src.core.exceptions import SessionNotFoundError


log = structlog.get_logger(__name__)
router = APIRouter(prefix="/sessions", tags=["sessions"])


# ... existing routes ...


@router.get(
    "/{session_id}/export",
    response_class=Response,
    summary="Export session data",
    description="Export session data to JSON, Markdown, or CSV format",
)
async def export_session(
    session_id: str,
    format: str = Query(
        "json",
        description="Export format: json, markdown, or csv",
        regex="^(json|markdown|csv)$",
    ),
    service: ExportService = Depends(lambda: ExportService()),
) -> Response:
    """
    Export session data to specified format.
    
    Args:
        session_id: Session ID to export
        format: Export format (json, markdown, csv)
        service: Injected export service
    
    Returns:
        Response with exported data and appropriate content-type
    
    Raises:
        HTTPException 404: If session not found
        HTTPException 400: If format is invalid
    """
    log_ctx = log.bind(session_id=session_id, format=format)
    
    log_ctx.info("export_session_requested")
    
    try:
        data = await service.export_session(session_id, format)
        
        # Set content-type based on format
        if format == "json":
            content_type = "application/json"
            filename = f"session_{session_id[:8]}.json"
        elif format == "markdown":
            content_type = "text/markdown"
            filename = f"session_{session_id[:8]}.md"
        else:  # csv
            content_type = "text/csv"
            filename = f"session_{session_id[:8]}.csv"
        
        log_ctx.info(
            "export_session_complete",
            content_type=content_type,
            content_length=len(data),
        )
        
        return Response(
            content=data,
            media_type=content_type,
            headers={
                "Content-Disposition": f'attachment; filename="{filename}"',
            },
        )
        
    except SessionNotFoundError as e:
        log_ctx.warning("export_session_not_found", error=str(e))
        raise HTTPException(
            status_code=404,
            detail=str(e),
        )
    except ValueError as e:
        log_ctx.warning("export_session_invalid_format", error=str(e))
        raise HTTPException(
            status_code=400,
            detail=str(e),
        )
    except Exception as e:
        log_ctx.error(
            "export_session_error",
            error_type=type(e).__name__,
            error_message=str(e),
        )
        raise HTTPException(
            status_code=500,
            detail=f"Export failed: {str(e)}",
        )
```

### tests/integration/test_export_api.py
```python
"""Integration tests for export API endpoints."""

import pytest
import json
from httpx import AsyncClient

from src.main import app


class TestExportEndpoint:
    """Tests for GET /sessions/{id}/export."""
    
    @pytest.mark.asyncio
    async def test_export_json(self):
        """Export to JSON returns valid JSON."""
        # First create a session
        async with AsyncClient(app=app, base_url="http://test") as client:
            # Create session (mocked)
            # ... session creation code ...
            
            # Export to JSON
            response = await client.get(
                "/sessions/test-session/export",
                params={"format": "json"},
            )
            
            # For now just test endpoint exists
            # In real test, would verify response
    
    @pytest.mark.asyncio
    async def test_export_markdown(self):
        """Export to Markdown returns text/markdown content."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get(
                "/sessions/test-session/export",
                params={"format": "markdown"},
            )
            
            # Verify content-type header
            # In real test with mock: assert response.status_code == 200
    
    @pytest.mark.asyncio
    async def test_export_csv(self):
        """Export to CSV returns text/csv content."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get(
                "/sessions/test-session/export",
                params={"format": "csv"},
            )
            
            # Verify content-type header
            # In real test with mock: assert response.status_code == 200
    
    @pytest.mark.asyncio
    async def test_invalid_format_returns_400(self):
        """Invalid format parameter returns 400."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get(
                "/sessions/test-session/export",
                params={"format": "xml"},  # Invalid
            )
            
            assert response.status_code == 422  # Query validation error
    
    @pytest.mark.asyncio
    async def test_nonexistent_session_returns_404(self):
        """Non-existent session returns 404."""
        async with AsyncClient(app=app, base_url="http://test") as client:
            response = await client.get(
                "/sessions/nonexistent/export",
                params={"format": "json"},
            )
            
            assert response.status_code == 404
```

## Requirements
1. GET /sessions/{id}/export endpoint
2. Query parameter for format (json, markdown, csv)
3. Returns appropriate content-type header
4. Includes Content-Disposition header with filename
5. Proper error handling (404 for not found, 400 for invalid format)

## Verification
```bash
# Run tests
pytest tests/integration/test_export_api.py -v

# Test endpoint with running server
curl "http://localhost:8000/sessions/test-session/export?format=json"
curl "http://localhost:8000/sessions/test-session/export?format=markdown"
curl "http://localhost:8000/sessions/test-session/export?format=csv"
```

## Success Criteria
- [ ] Export endpoint added to sessions.py
- [ ] Query parameter validation for format
- [ ] Correct content-type for each format
- [ ] Content-Disposition header with filename
- [ ] Error handling for missing sessions
- [ ] Integration tests pass
